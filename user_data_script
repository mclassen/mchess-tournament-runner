#!/bin/bash
set -eux

apt-get update
apt-get install -y unzip curl git build-essential

# Install AWS CLI v2 (Ubuntu 24.04)
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip -q awscliv2.zip
./aws/install

# IMPORTANT: must match your release_tag exactly
TAG="master-vs-483"

mkdir -p /opt/mchess
cd /opt/mchess

curl -L -o mchess.tar.gz \
  "https://github.com/mclassen/mchess-tournament-runner/releases/download/${TAG}/mchess_bundle.tar.gz"

tar -xzf mchess.tar.gz

ENGINE_A_CMD="./mchess_master uci" \
ENGINE_B_CMD="./mchess_feature uci" \
ENGINE_A_NAME="master" \
ENGINE_B_NAME="feature" \
GAMES=2000 \
THREADS_PER_ENGINE=2 \
CONCURRENCY=8 \
HASH_MB=64 \
./run_tournament.sh

TS=$(date +%s)
aws s3 cp /root/results/match.pgn "s3://mchess-tournaments-results/${TAG}-tournament-${TS}.pgn"
aws s3 cp /root/results/tournament.log "s3://mchess-tournaments-results/${TAG}-tournament-${TS}.log"

shutdown -h now
